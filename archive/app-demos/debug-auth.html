<!DOCTYPE html>
<html>
<head>
    <title>Debug Auth - M√§klarsystem</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }
        .section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        button {
            background: #3b82f6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 250px;
        }
    </style>
</head>
<body>
    <h1>üîç Debug Auth - M√§klarsystem</h1>
    
    <div class="section">
        <h2>1. Milj√∂variabler</h2>
        <div id="env-check">Kontrollerar...</div>
    </div>

    <div class="section">
        <h2>2. Supabase Anslutning</h2>
        <div id="connection-check">Kontrollerar...</div>
    </div>

    <div class="section">
        <h2>3. Test Inloggning</h2>
        <input type="email" id="email" value="anna.andersson@maklarsystem.se" placeholder="E-post">
        <input type="password" id="password" value="testpassword123" placeholder="L√∂senord">
        <br>
        <button onclick="testLogin()">Testa Inloggning</button>
        <button onclick="checkSession()">Kontrollera Session</button>
        <button onclick="logout()">Logga ut</button>
        <div id="login-result"></div>
    </div>

    <div class="section">
        <h2>4. Anv√§ndare i Databasen</h2>
        <button onclick="checkUsers()">Kontrollera Anv√§ndare</button>
        <div id="users-result"></div>
    </div>

    <div class="section">
        <h2>5. Session Status</h2>
        <div id="session-status">Ingen session</div>
    </div>

    <div class="section">
        <h2>6. Konsol Logg</h2>
        <pre id="console-log"></pre>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
        
        let supabase;
        const log = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            log.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            document.getElementById('console-log').textContent = log.join('\n');
        }
        
        // Kontrollera milj√∂variabler
        async function checkEnv() {
            try {
                const response = await fetch('/api/env-check');
                const data = await response.json();
                
                if (data.supabaseUrl && data.supabaseAnonKey) {
                    document.getElementById('env-check').innerHTML = `
                        <span class="success">‚úì Milj√∂variabler hittade</span><br>
                        URL: ${data.supabaseUrl}<br>
                        Key: ${data.supabaseAnonKey.substring(0, 20)}...
                    `;
                    
                    // Initiera Supabase
                    supabase = createClient(data.supabaseUrl, data.supabaseAnonKey);
                    window.supabase = supabase;
                    addLog('Supabase client initierad', 'success');
                    
                    // Kontrollera anslutning
                    checkConnection();
                } else {
                    document.getElementById('env-check').innerHTML = '<span class="error">‚úó Milj√∂variabler saknas!</span>';
                    addLog('Milj√∂variabler saknas', 'error');
                }
            } catch (error) {
                document.getElementById('env-check').innerHTML = '<span class="error">‚úó Kunde inte kontrollera milj√∂variabler</span>';
                addLog('Fel vid kontroll av milj√∂variabler: ' + error.message, 'error');
            }
        }
        
        async function checkConnection() {
            try {
                const { data, error } = await supabase.from('users').select('count').limit(1);
                
                if (error) {
                    document.getElementById('connection-check').innerHTML = `<span class="error">‚úó Anslutningsfel: ${error.message}</span>`;
                    addLog('Anslutningsfel: ' + error.message, 'error');
                } else {
                    document.getElementById('connection-check').innerHTML = '<span class="success">‚úì Ansluten till Supabase</span>';
                    addLog('Ansluten till Supabase', 'success');
                }
            } catch (error) {
                document.getElementById('connection-check').innerHTML = `<span class="error">‚úó Fel: ${error.message}</span>`;
                addLog('Anslutningsfel: ' + error.message, 'error');
            }
        }
        
        window.testLogin = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            addLog(`F√∂rs√∂ker logga in som ${email}...`, 'info');
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) {
                    document.getElementById('login-result').innerHTML = `<span class="error">‚úó Inloggningsfel: ${error.message}</span>`;
                    addLog('Inloggningsfel: ' + error.message, 'error');
                } else {
                    document.getElementById('login-result').innerHTML = `
                        <span class="success">‚úì Inloggad!</span><br>
                        User ID: ${data.user.id}<br>
                        Email: ${data.user.email}
                    `;
                    addLog('Inloggning lyckades! User ID: ' + data.user.id, 'success');
                    checkSession();
                }
            } catch (error) {
                document.getElementById('login-result').innerHTML = `<span class="error">‚úó Fel: ${error.message}</span>`;
                addLog('Fel vid inloggning: ' + error.message, 'error');
            }
        }
        
        window.checkSession = async function() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session) {
                    document.getElementById('session-status').innerHTML = `
                        <span class="success">‚úì Aktiv session</span><br>
                        User: ${session.user.email}<br>
                        Expires: ${new Date(session.expires_at * 1000).toLocaleString()}
                    `;
                    addLog('Aktiv session hittad', 'success');
                } else {
                    document.getElementById('session-status').innerHTML = '<span class="error">‚úó Ingen session</span>';
                    addLog('Ingen aktiv session', 'warning');
                }
            } catch (error) {
                document.getElementById('session-status').innerHTML = `<span class="error">‚úó Fel: ${error.message}</span>`;
                addLog('Fel vid sessionskontroll: ' + error.message, 'error');
            }
        }
        
        window.logout = async function() {
            try {
                const { error } = await supabase.auth.signOut();
                
                if (error) {
                    addLog('Utloggningsfel: ' + error.message, 'error');
                } else {
                    addLog('Utloggad', 'success');
                    document.getElementById('session-status').innerHTML = '<span class="error">‚úó Ingen session</span>';
                    document.getElementById('login-result').innerHTML = '';
                }
            } catch (error) {
                addLog('Fel vid utloggning: ' + error.message, 'error');
            }
        }
        
        window.checkUsers = async function() {
            try {
                const { data: publicUsers, error: publicError } = await supabase
                    .from('users')
                    .select('*');
                
                if (publicError) {
                    document.getElementById('users-result').innerHTML = `<span class="error">‚úó Fel: ${publicError.message}</span>`;
                    addLog('Fel vid h√§mtning av anv√§ndare: ' + publicError.message, 'error');
                } else {
                    let html = '<h3>Public Users:</h3><ul>';
                    publicUsers.forEach(user => {
                        html += `<li>${user.email} (ID: ${user.id})</li>`;
                    });
                    html += '</ul>';
                    
                    document.getElementById('users-result').innerHTML = html;
                    addLog(`${publicUsers.length} anv√§ndare hittade i public.users`, 'info');
                }
            } catch (error) {
                document.getElementById('users-result').innerHTML = `<span class="error">‚úó Fel: ${error.message}</span>`;
                addLog('Fel vid databaskontroll: ' + error.message, 'error');
            }
        }
        
        // Starta kontroller
        checkEnv();
    </script>
</body>
</html>